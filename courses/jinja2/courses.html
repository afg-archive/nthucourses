{% extends "base.html" %}

{% block title %}課程{% endblock %}

{% block style %}
{{ super() }}
td.notes,
th.notes {
  width: 25%;
}
.notes {
  white-space: pre-warp;
}
th.sortable > span.text {
  cursor: pointer;
  text-decoration: blink;
  border-bottom: 1px dotted #333;
}
{% endblock %}

{% block content %}
<div class="modal" id="syllabusModal" tabindex="-1" role="dialog" aria-labelledby="syllabusModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h3 class="modal-title" id="syllabusModalLabel"><span id="syllabus-title"></span> <small id="syllabus-title-en"></small></h4>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col-sm-6 col-md-4">
            <p id="syllabus-no"></p>
            <p>
              <span id="syllabus-teacher"></span> -
              <span id="syllabus-time"></span> @ 
              <span id="syllabus-room"></span>
            </p>
            <p>
              <span id="syllabus-enrollment"></span> / 
              <span id="syllabus-size-limit"></span>, 
              <span id="syllabus-credit"></span> 學分
            </p>
          </div>
          <div class="col-sm-6 col-md-4">
            <p id="syllabus-notes" class="notes"></p>
          </div>
          <div class="col-sm-12 col-md-12">
            <h4>Syllabus</h4>
            <pre id="syllabus-content"></pre>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">關閉</button>
      </div>
    </div>
  </div>
</div>

<div class="alert alert-warning">
  本站所列之課程資訊僅供參考，實際課程內容請以<a target="_blank" href="https://www.ccxp.nthu.edu.tw/ccxp/INQUIRE/JH/6/6.2/6.2.9/JH629001.php">課務組公告</a>為準。
</div>
<form class="form-inline">
  {{ render_form(form, layout='inline') }}
  <input class="btn btn-default" type="submit">
</form>
{% if result %}
<hr>
<table class="table" id="resulttable">
  <caption>{{ result.courses.__len__() }} 個搜尋結果，更新：{{ localtime(result.updated).strftime('%Y/%m/%d') }}，提示：點擊欄位名稱進行排序。</caption>
  <thead>
    <tr>
      {% for id, text in [
        ['no', '科號'],
        ['title', '名稱'],
        ['teacher', '教師'],
        ['time', '時間'],
        ['credit', '學分'],
        ['npeople', '人數'],
        ['room', '教室'],
      ] %}
      <th class="sortable" id="th_{{ id }}"><span class="text">{{ text }}</span></th>
      {% endfor %}
      <th class="notes">備註</th>
    </tr>
  </thead>
</table>
{% endif %}
{% endblock %}

{% block endbody %}
{% if result %}
<script>
  var result = {{ json(result) }};
  var display = function () {
    d3.select('#resulttable').selectAll('tbody').remove();
    var table = d3.select('#resulttable').append('tbody');
    for (var i = 0; i != result.courses.length; ++ i) {
      var tr = table.append('tr');
      var course = result.courses[i];
      tr.append('td').text(course.no);
      var title = tr.append('td');
      var titleline = title.append('div');
      titleline.append('a')
        .attr({
          'href': '#syllabusModal',
          'data-toggle': 'modal',
          'data-target': '#syllabusModal',
          'data-index': i
        })
        .text(course.title_zh);
      titleline.append('span').text(' ');
      titleline.append('a')
        .attr({
          'href': '/course/' + course.pk + '/',
          'target': '_blank'
        })
        .append('span')
        .attr({
          'class': 'glyphicon glyphicon-new-window',
          'title': '在新頁面中開啟'
        });
      if (course.ge_line) {
        title.append('div')
          .attr({
            'class': 'ge_line'
          })
          .text(course.ge_line);
      }
      tr.append('td').text(course.teacher);
      tr.append('td').text(course.time);
      tr.append('td').text(course.credit);
      tr.append('td').text(course.enrollment + (course.size_limit? " / " + course.size_limit: "" ));
      tr.append('td').text(course.room);
      tr.append('td')
        .attr({
          'class': 'notes'
        })
        .text(course.notes);
    }
  }
  display();
  $('#syllabusModal').on('show.bs.modal', function (event) {
    var button = $(event.relatedTarget) // Button that triggered the modal
    var index = button.data('index');
    var course = result.courses[index];
    // var recipient = button.data('whatever') // Extract info from data-* attributes
    // If necessary, you could initiate an AJAX request here (and then do the updating in a callback).
    // Update the modal's content. We'll use jQuery here, but you could use a data binding library or other methods instead.
    var modal = $(this)
    modal.find('#syllabus-title').text(course.title_zh);
    modal.find('#syllabus-title-en').text(course.title_en);
    modal.find('#syllabus-no').text(course.no);
    modal.find('#syllabus-teacher').text(course.teacher);
    modal.find('#syllabus-time').text(course.time);
    modal.find('#syllabus-room').text(course.room);
    modal.find('#syllabus-enrollment').text(course.enrollment);
    modal.find('#syllabus-size-limit').text(course.size_limit);
    modal.find('#syllabus-credit').text(course.credit);
    modal.find('#syllabus-notes').text(course.notes);
    modal.find('#syllabus-content').text(course.syllabus);
    // modal.find('.modal-body input').val(recipient)
  })
  var set_current_ordering = function(obj) {
    obj.append('span').attr('class', 'sorticon').text(' ');
    obj.append('span').attr('class', 'glyphicon glyphicon-arrow-down sorticon');
  }
  var sort_by = function (name) {
    return function() {
      d3.selectAll('.sorticon').remove();
      set_current_ordering(d3.select(this));
      result.courses.sort( function (a, b) {
        if (a[name] > b[name]) return 1;
        if (a[name] < b[name]) return -1;
        if (a.no > b.no) return 1;
        if (a.no < b.no) return -1;
        return 0;
      });
      display();
    }
  }
  set_current_ordering(d3.select('#th_no'));
  $('#th_no').click(sort_by('no'));
  $('#th_title').click(sort_by('title_zh'));
  $('#th_teacher').click(sort_by('teacher'));
  $('#th_time').click(sort_by('time'));
  $('#th_credit').click(sort_by('credit'));
  $('#th_npeople').click(sort_by('size_limit'));
  $('#th_room').click(sort_by('room'));
</script>
{% endif %}
{% endblock %}
